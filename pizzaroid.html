<html>
  <header>
    <title>Pizzaroid!</title>
    <style>
      body {
        padding: 0;
        margin: 0;
        background: #000;
      }

      img,
      span {
        position: fixed;
      }
    </style>
  </header>
  <body>
    <img id="pizza" src="img/pizza.svg" alt="pizza" />
  </body>
  <script type="module">
    import "./js/pizzaroid-functions.js";

    const pizza = document.getElementById("pizza");
    const pizzaSprite = {
      dom: pizza,
      w: 20,
      h: 30,
      rot: 0,
      delRot: 0,
      x: viewWidth / 2,
      delX: 0,
      y: viewHeight / 2,
      delY: 0,
    };

    populateAsterooms(10);
    function mainLoop() {
      //change rotation and velocity of the pizza depending on controls
      applyControls(pizzaSprite);

      //apply friction to the pizza and exhaust particles
      applyFriction(pizzaSprite, FRICTION);
      for (i = 0; i < propelParticles.length; i++) {
        applyFriction(propelParticles[i], CHSFRICTION);
      }

      //if the propellant particles are still, remove them
      removeStationaryPropelParticles();

      //add the velocity to the position and rotation each increment
      applyInertia(pizzaSprite);
      for (i = 0; i < propelParticles.length; i++) {
        applyInertia(propelParticles[i]);
      }
      for (i = 0; i < asterooms.length; i++) {
        applyInertia(asterooms[i]);
      }
      for (i = 0; i < bullets.length; i++) {
        applyInertia(bullets[i]);
      }

      //if the sprite goes out of bounds, reflect it back in on the opposite side
      reflectOutOfBounds(pizzaSprite);
      for (i = 0; i < asterooms.length; i++) {
        reflectOutOfBounds(asterooms[i]);
      }

      //if a bullet collides with an asteroom, break the asteroom apart and delete the bullet
      for (i = 0; i < bullets.length; i++) {
        for (j = 0; j < asterooms.length; j++) {
          if (spritesTouching(bullets[i], asterooms[j])) {
            bullets[i].dom.remove();
            bullets.splice(i, 1);
            spawnChildAsterooms(asterooms[j]);
            asterooms[j].dom.remove();
            asterooms.splice(j, 1);
          }
        }
      }

      //if the ship collides with an asteroom, YOU LOSE
      for (i = 0; i < asterooms.length; i++) {
        if (spritesTouching(pizzaSprite, asterooms[i])) {
          placeExplosion(pizzaSprite, asterooms[i]);
          clearInterval(timerId);
          setTimeout(() => {
            displayText("YOU LOSE");
          }, 500);
        }
      }

      if (asterooms.length == 0) {
        clearInterval(timerId);
        setTimeout(() => {
          displayText("YOU WIN");
        }, 500);
      }
      //if bullets have gone out of bounds, remove them
      removeOutOfBoundsBullets();

      //reposition the sprite to the updated position
      updateDomPosition(pizzaSprite);
      for (i = 0; i < propelParticles.length; i++) {
        updateDomPosition(propelParticles[i]);
      }
      for (i = 0; i < asterooms.length; i++) {
        updateDomPosition(asterooms[i]);
      }
      for (i = 0; i < bullets.length; i++) {
        updateDomPosition(bullets[i]);
      }
    }

    //set up a timer to progress the game in increments at 100/second
    const timerId = setInterval(mainLoop, 20);

    //listen for keydown and keyup events to update "control" object
    addEventListener("keydown", (event) => {
      console.log(event.key);
      if (event.key === "a") {
        controls.a = true;
      }
      if (event.key === "d") {
        controls.d = true;
      }
      if (event.key === "w") {
        controls.w = true;
      }
      if (event.key === " ") {
        if (!controls.space) {
          spawnBullet();
        }
        controls.space = true;
      }
    });
    addEventListener("keyup", (event) => {
      if (event.key === "a") {
        controls.a = false;
      }
      if (event.key === "d") {
        controls.d = false;
      }
      if (event.key === "w") {
        controls.w = false;
      }
      if (event.key === " ") {
        controls.space = false;
      }
    });
  </script>
</html>
